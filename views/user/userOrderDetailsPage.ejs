<!DOCTYPE html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Evara - eCommerce HTML Template</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge" />
    <meta name="description" content="" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta property="og:title" content="" />
    <meta property="og:type" content="" />
    <meta property="og:url" content="" />
    <meta property="og:image" content="" />

    <!-- Google fonts -->

    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <!-- Favicon -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="/user/assets/imgs/theme/favicon.svg"
    />
    <!-- Template CSS -->
    <link rel="stylesheet" href="/user/assets/css/main.css?v=3.4" />

    <style>
      .modal {
    display: none;
    position: fixed;
    z-index: 1;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    overflow: auto;
    background-color: rgb(0, 0, 0);
    background-color: rgba(0, 0, 0, 0.4);
}

      .modal-content {
    position: relative; /* Ensures absolute positioning works within this container */
    background-color: #fff;
    padding: 20px;
    border: 1px solid #888;
    width: 400px; /* Adjust as needed */
    margin: 15% auto; /* Center the modal on the page */
    border-radius: 10px;
}

.close {
    position: absolute;
    right: 20px; /* Adjust this value to your preference */
    top: 10px; /* Adjust this value to your preference */
    color: #aaa;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
    transition: color 0.3s ease;
}

.close:hover,
.close:focus {
    color: #000;
    text-decoration: none;
}

textarea {
    width: 100%;
    height: 100px;
    margin-top: 10px;
    padding: 10px;
    border-radius: 5px;
    border: 1px solid #ccc;
    font-size: 16px;
    resize: vertical; /* Allows vertical resizing only */
}

#confirmReturn {
    margin-top: 15px;
    padding: 10px 20px;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    transition: background-color 0.3s ease;
}

#confirmReturn:hover {
    background-color: #0056b3;
}

/* modalends */

dl.dlist {
        display: flex;
        flex-wrap: wrap;
    }

      form .inputBox {
    position: relative;
    width: 100%;
}
.img-lg {
    width: 80px;
    height: 80px;
}


form .inputBox input {
    margin-bottom: 6px;
    position: relative;
    width: 100%;
    background: white;
    outline: none;
    padding: 10px 20px 7.5px;
    border-radius: 4px;
    color: #1d1a1a;
    font-weight: 500;
    font-size: 1em;

}

form .inputBox i {
    position: absolute;
    left: 10px;
    top: 15px;
    font-style: normal;
    color: #5e5e5e;
    transition: 0.5s;
    pointer-events: none;
}

form .inputBox input:focus ~ i,
form .inputBox input:valid ~ i {
    transform: translateY(-20px);
    font-size: 0.8em;
    color: #aaa;
}
    </style>
  </head>

  <body>
    <header class="header-area header-style-5">
      <%-include('./layouts/topNavbar.ejs') %>
      <%-include('./layouts/middleNavbar.ejs') %>
    </header>
    <div class="mobile-header-active mobile-header-wrapper-style">
      <div class="mobile-header-wrapper-inner">
        <div class="mobile-header-top">
          <div class="mobile-header-logo">
            <a href="index.html"
              ><img src="/user/assets/imgs/theme/logo.svg" alt="logo"
            /></a>
          </div>
          <div
            class="mobile-menu-close close-style-wrap close-style-position-inherit"
          >
            <button class="close-style search-close">
              <i class="icon-top"></i>
              <i class="icon-bottom"></i>
            </button>
          </div>
        </div>
        <div class="mobile-header-content-area">
          <div class="mobile-search search-style-3 mobile-header-border">
            <form action="#">
              <input type="text" placeholder="Search for items…" />
              <button type="submit"><i class="fi-rs-search"></i></button>
            </form>
          </div>
          <div class="mobile-menu-wrap mobile-header-border">
            <div class="main-categori-wrap mobile-header-border">
              <a class="categori-button-active-2" href="#">
                <span class="fi-rs-apps"></span> Browse Categories
              </a>
              <div
                class="categori-dropdown-wrap categori-dropdown-active-small"
              >
                <ul>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-dress"></i>Women's Clothing</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-tshirt"></i>Men's Clothing</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-smartphone"></i> Cellphones</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-desktop"></i>Computer & Office</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-cpu"></i>Consumer Electronics</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-home"></i>Home & Garden</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-high-heels"></i>Shoes</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-teddy-bear"></i>Mother & Kids</a
                    >
                  </li>
                  <li>
                    <a href="shop-grid-right.html"
                      ><i class="evara-font-kite"></i>Outdoor fun</a
                    >
                  </li>
                </ul>
              </div>
            </div>
            <!-- mobile menu start -->
            <nav>
              <ul class="mobile-menu">
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="index.html">Home</a>
                  <ul class="dropdown">
                    <li><a href="index.html">Home 1</a></li>
                    <li><a href="index-2.html">Home 2</a></li>
                    <li><a href="index-3.html">Home 3</a></li>
                    <li><a href="index-4.html">Home 4</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span
                  ><a href="shop-grid-right.html">shop</a>
                  <ul class="dropdown">
                    <li>
                      <a href="shop-grid-right.html"
                        >Shop Grid – Right Sidebar</a
                      >
                    </li>
                    <li>
                      <a href="shop-grid-left.html">Shop Grid – Left Sidebar</a>
                    </li>
                    <li>
                      <a href="shop-list-right.html"
                        >Shop List – Right Sidebar</a
                      >
                    </li>
                    <li>
                      <a href="shop-list-left.html">Shop List – Left Sidebar</a>
                    </li>
                    <li><a href="shop-fullwidth.html">Shop - Wide</a></li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Single Product</a>
                      <ul class="dropdown">
                        <li>
                          <a href="shop-product-right.html"
                            >Product – Right Sidebar</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-left.html"
                            >Product – Left Sidebar</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-full.html"
                            >Product – No sidebar</a
                          >
                        </li>
                      </ul>
                    </li>
                    <li><a href="shop-filter.html">Shop – Filter</a></li>
                    <li><a href="shop-wishlist.html">Shop – Wishlist</a></li>
                    <li><a href="shop-cart.html">Shop – Cart</a></li>
                    <li><a href="shop-checkout.html">Shop – Checkout</a></li>
                    <li><a href="shop-compare.html">Shop – Compare</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Mega menu</a>
                  <ul class="dropdown">
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Women's Fashion</a>
                      <ul class="dropdown">
                        <li><a href="shop-product-right.html">Dresses</a></li>
                        <li>
                          <a href="shop-product-right.html">Blouses & Shirts</a>
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Hoodies & Sweatshirts</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html">Women's Sets</a>
                        </li>
                      </ul>
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Men's Fashion</a>
                      <ul class="dropdown">
                        <li><a href="shop-product-right.html">Jackets</a></li>
                        <li>
                          <a href="shop-product-right.html"
                            >Casual Faux Leather</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html">Genuine Leather</a>
                        </li>
                      </ul>
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Technology</a>
                      <ul class="dropdown">
                        <li>
                          <a href="shop-product-right.html">Gaming Laptops</a>
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Ultraslim Laptops</a
                          >
                        </li>
                        <li><a href="shop-product-right.html">Tablets</a></li>
                        <li>
                          <a href="shop-product-right.html"
                            >Laptop Accessories</a
                          >
                        </li>
                        <li>
                          <a href="shop-product-right.html"
                            >Tablet Accessories</a
                          >
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span
                  ><a href="blog-category-fullwidth.html">Blog</a>
                  <ul class="dropdown">
                    <li>
                      <a href="blog-category-grid.html">Blog Category Grid</a>
                    </li>
                    <li>
                      <a href="blog-category-list.html">Blog Category List</a>
                    </li>
                    <li>
                      <a href="blog-category-big.html">Blog Category Big</a>
                    </li>
                    <li>
                      <a href="blog-category-fullwidth.html"
                        >Blog Category Wide</a
                      >
                    </li>
                    <li class="menu-item-has-children">
                      <span class="menu-expand"></span
                      ><a href="#">Single Product Layout</a>
                      <ul class="dropdown">
                        <li><a href="blog-post-left.html">Left Sidebar</a></li>
                        <li>
                          <a href="blog-post-right.html">Right Sidebar</a>
                        </li>
                        <li>
                          <a href="blog-post-fullwidth.html">No Sidebar</a>
                        </li>
                      </ul>
                    </li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Pages</a>
                  <ul class="dropdown">
                    <li><a href="page-about.html">About Us</a></li>
                    <li><a href="page-contact.html">Contact</a></li>
                    <li><a href="page-account.html">My Account</a></li>
                    <li>
                      <a href="page-login-register.html">login/register</a>
                    </li>
                    <li>
                      <a href="page-purchase-guide.html">Purchase Guide</a>
                    </li>
                    <li>
                      <a href="page-privacy-policy.html">Privacy Policy</a>
                    </li>
                    <li><a href="page-terms.html">Terms of Service</a></li>
                    <li><a href="page-404.html">404 Page</a></li>
                  </ul>
                </li>
                <li class="menu-item-has-children">
                  <span class="menu-expand"></span><a href="#">Language</a>
                  <ul class="dropdown">
                    <li><a href="#">English</a></li>
                    <li><a href="#">French</a></li>
                    <li><a href="#">German</a></li>
                    <li><a href="#">Spanish</a></li>
                  </ul>
                </li>
              </ul>
            </nav>
            <!-- mobile menu end -->
          </div>
          <div class="mobile-header-info-wrap mobile-header-border">
            <div class="single-mobile-header-info mt-30">
              <a href="page-contact.html"> Our location </a>
            </div>
            <div class="single-mobile-header-info">
              <a href="page-login-register.html">Log In / Sign Up </a>
            </div>
            <div class="single-mobile-header-info">
              <a href="#">(+01) - 2345 - 6789 </a>
            </div>
          </div>
          <div class="mobile-social-icon">
            <h5 class="mb-15 text-grey-4">Follow Us</h5>
            <a href="#"
              ><img src="/user/assets/imgs/theme/icons/icon-facebook.svg" alt=""
            /></a>
            <a href="#"
              ><img src="/user/assets/imgs/theme/icons/icon-twitter.svg" alt=""
            /></a>
            <a href="#"
              ><img src="/user/assets/imgs/theme/icons/icon-instagram.svg" alt=""
            /></a>
            <a href="#"
              ><img src="/user/assets/imgs/theme/icons/icon-pinterest.svg" alt=""
            /></a>
            <a href="#"
              ><img src="/user/assets/imgs/theme/icons/icon-youtube.svg" alt=""
            /></a>
          </div>
        </div>
      </div>
    </div>
    <main class="main">
      <div class="page-header breadcrumb-wrap">
        <div class="container">
          <div class="breadcrumb">
            <a href="index.html" rel="nofollow">Home</a>
            <span></span> Pages <span></span> Login / Register
          </div>
        </div>
      </div>
      <section class="pt-70 pb-70">        
        <div class="container">
          <section class="content-main">
            <div class="content-header">
                <div>
                    <h2 class="content-title card-title">Order detail</h2>
                    <p>Details for Order ID: <%= order.orderId %></p>
                </div>
            </div>
            <div class="card">
                <header class="card-header">
                    <div class="row align-items-center">
                        <div class="col-lg-6 col-md-6 mb-lg-0 mb-15">
                            <span>
                                <i class="material-icons md-calendar_today"></i> <b><%= order.date %></b>
                            </span> <br>
                            <small class="text-muted">Order ID: <%= order.orderId %></small>
                        </div>
                        
                        <% 
                        const allDelivered = order.products.every(product => product.status === 'Delivered'); 
                      %>
                      
                      <div class="col-lg-6 col-md-6 ms-auto text-md-end">
                        <% if (allDelivered) { %>
                          <a class="btn btn-secondary print ms-2" href="download-invoice/<%=order._id%>">
                            <span class="material-symbols-outlined">print</span>
                          </a>
                        <% } %>
                      </div>
                      
                    </div>
                </header>
                <div class="card-body">
                    <div class="row mb-50 mt-20 order-info-wrap">
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-person"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Customer</h6>
                                    <p class="mb-1">
                                        <%= order.address[0].name %> <br> <%= order.address[0].city %> <br> <%= order.address[0].mobile %>
                                    </p>
                                    <a href="#">View profile</a>
                                </div>
                            </article>
                        </div>
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-local_shipping"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Order info</h6>
                                    <p class="mb-1">
                                        <%=order.address[0].name%> ,<br />
                                        <%=order.address[0].street %>,<br />
                                        <%=order.address[0].city %>,<br />
                                        <%=order.address[0].state %>,<br />
                                        <%=order.address[0].pincode %>,<br />
                                        <%=order.address[0].country %>,<br />
                                        <%=order.address[0].mobile %>,<br />
                                    </p>
                                </div>
                            </article>
                        </div>
                        <div class="col-md-4">
                            <article class="icontext align-items-start">
                                <span class="icon icon-sm rounded-circle bg-primary-light">
                                    <i class="text-primary material-icons md-place"></i>
                                </span>
                                <div class="text">
                                    <h6 class="mb-1">Deliver to</h6>
                                    <p class="mb-1">
                                        City: <%= order.address[0].city %>, <%= order.address[0].country %> <br> <%= order.address[0].street %>, <%= order.address[0].state %> <br> Po Box <%= order.address[0].pincode %>
                                    </p>
                                </div>
                            </article>
                        </div>
                    </div>
                     <div class="row">
                            <div class="table-responsive">
                                <table class="table" style="border-collapse: collapse; width: 100%;">
                                    <thead>
                                        <tr style="border: none;">
                                            <th style="border: none;" class="text-center" width="40%">Product</th>
                                            <th style="border: none;" class="text-center" width="15%">Unit Price</th>
                                            <th style="border: none;" class="text-center" width="10%">Quantity</th>
                                            <th width="10%" style="border: none;" class="text-end">Total</th>
                                            <th style="border: none;" class="text-center" width="25%">Product Status | Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% order.products.forEach(product => { %>
                                        <tr style="border: none;">
                                            <td style="border: none;">
                                                <a class="itemside d-flex align-items-center" href="#">
                                                    <div class="left">
                                                        <img src="/<%= product.productId.image[1] ? product.productId.image[1].replace(/\\/g, '/') : product.productId.image[0].replace(/\\/g, '/') %>" width="40" height="40" class="img-lg" alt="Item">
                                                    </div>
                                                    <div class="info">
                                                        <%= product.productId.name %>
                                                    </div>
                                                </a>
                                            </td>
                                            <td style="border: none;" class="text-center"> ₹<%= (order.freeShipping ? product.productPrice : (product.productPrice - 500)).toFixed(2) %></td>
                                            <td style="border: none;" class="text-center"> <%= product.quantity %> </td>
                                            <td style="border: none;" class="text-end"> ₹<%= ((order.freeShipping ? product.productPrice : (product.productPrice - 500)) * product.quantity).toFixed(2) %></td>
                                            <td style="border: none;" class="text-center">
                                              <%=product.status %> |
                                              <% if (product.status === 'Pending' || product.status === 'Processing') { %>
                                                  <button class="btn btn-sm btn-warning" onclick="cancelProduct('<%= order._id %>', '<%= product._id %>')">Cancel</button>
                                              <% } else if (product.status === 'Delivered') { %>
                                                  <button class="btn btn-sm btn-success" onclick="openReturnModal('<%= order._id %>', '<%= product._id %>')">Return</button>
                                              <% } else if(product.status === 'Return Success'|| 'Return Pending') {
                                                %> <span> Product returned</span><%
                                              }else { %>
                                                  <button class="btn btn-sm btn-secondary" disabled>Cannot Cancel</button>
                                              <% } %>
                                          </td>
                                          
                                        </tr style="border: none;">
                                        <% }) %>
                                        <tr>
                                            <td style="border: none;" colspan="5">
                                                <article class="float-end">
                                                    <dl class="dlist">
                                                        <dt>Subtotal:</dt>
                                                        <dd>₹<%= (order.freeShipping ? order.payableAmount : (order.payableAmount - 500)).toFixed(2) %></dd>
                                                    </dl>
                                                    <dl class="dlist">
                                                        <dt>Shipping cost:</dt>
                                                        <dd>₹<%= (order.freeShipping ? 0 : 500).toFixed(2) %></dd>
                                                    </dl>
                                                    <dl class="dlist">
                                                        <dt>Grand total:</dt>
                                                        <dd>
                                                            <b class="h5">₹<%= (order.payableAmount ).toFixed(2) %></b>
                                                        </dd>
                                                    </dl>
                                                    <dl class="dlist">
                                                      <dt class="text-muted">Payment Status:</dt>
                                                      <dd>
                                                        <span class="badge rounded-pill alert-<%= 
                                                        order.paymentStatus === 'Failed' ? 'danger' : 
                                                        order.paymentStatus === 'Pending' ? 'warning' : 
                                                        'success' 
                                                        %> text-<%= 
                                                        order.paymentStatus === 'Failed' ? 'danger' : 
                                                        order.paymentStatus === 'Pending' ? 'warning' : 
                                                        'success' 
                                                        %>">
                                                        <%= 
                                                        order.paymentStatus === 'Failed' ? 'Payment Failed' : 
                                                        order.paymentStatus === 'Pending' ? 'Payment Pending' : 
                                                        'Payment Done' 
                                                        %>
                                                        </span>
                                                        </dd>
                                                        </dl>
                                                        
                                                        <% if (order.paymentStatus === 'Pending') { %>
                                                            <button class="btn btn-primary mt-2" onclick="retryPayment('<%= order._id %>', '<%= order.payableAmount %>')">Retry Payment</button>
                                                        <% } %>
                                                </article>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        <div class="col-lg-7">
                        </div>
                        <div class="col-lg-1"></div>
                        <div class="col-lg-4"></div>
                    </div>
                </div>
            </div>
        </section> <!-- content-main end-->
        </div>
      </section>
    <!-- Modal -->
    <div id="returnModal" class="modal" style="display:none;">
        <div class="modal-content">
            <span class="close" onclick="closeReturnModal()">&times;</span>
            <h2>Return Product</h2>
            <p>Please provide a reason for the return:</p>
            <textarea id="returnReason" placeholder="Enter your reason here..."></textarea>
            <button class="btn " id="confirmReturn" onclick="submitReturn()">Submit</button>
        </div>
    </div>
    </main>
    <%-include('./layouts/footer.ejs') %>

    <!-- Preloader Start -->
    <div id="preloader-active">
      <div class="preloader d-flex align-items-center justify-content-center">
        <div class="preloader-inner position-relative">
          <div class="text-center">
            <h5 class="mb-5">Now Loading</h5>
            <div class="loader">
              <div class="bar bar1"></div>
              <div class="bar bar2"></div>
              <div class="bar bar3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>



    <!-- Vendor JS-->
    <script src="/user/assets/js/vendor/modernizr-3.6.0.min.js"></script>
    <script src="/user/assets/js/vendor/jquery-3.6.0.min.js"></script>
    <script src="/user/assets/js/vendor/jquery-migrate-3.3.0.min.js"></script>
    <script src="/user/assets/js/vendor/bootstrap.bundle.min.js"></script>
    <script src="/user/assets/js/plugins/slick.js"></script>
    <script src="/user/assets/js/plugins/jquery.syotimer.min.js"></script>
    <script src="/user/assets/js/plugins/wow.js"></script>
    <script src="/user/assets/js/plugins/jquery-ui.js"></script>
    <script src="/user/assets/js/plugins/perfect-scrollbar.js"></script>
    <script src="/user/assets/js/plugins/magnific-popup.js"></script>
    <script src="/user/assets/js/plugins/select2.min.js"></script>
    <script src="/user/assets/js/plugins/waypoints.js"></script>
    <script src="/user/assets/js/plugins/counterup.js"></script>
    <script src="/user/assets/js/plugins/jquery.countdown.min.js"></script>
    <script src="/user/assets/js/plugins/images-loaded.js"></script>
    <script src="/user/assets/js/plugins/isotope.js"></script>
    <script src="/user/assets/js/plugins/scrollup.js"></script>
    <script src="/user/assets/js/plugins/jquery.vticker-min.js"></script>
    <script src="/user/assets/js/plugins/jquery.theia.sticky.js"></script>
    <!-- Template  JS -->
    <script src="/user/assets/js/main.js?v=3.4"></script>
    <!-- sweet alert -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    // razorpay
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <script>
      async function retryPayment(orderId, amount) {
    try {
      
        const retryResponse = await fetch('/retry-payment', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ orderId, amount })
        });

        if (retryResponse.ok) {
          console.log("Retry payment response:", retryResponse);
            const retryData = await retryResponse.json();
            console.log("Retry payment data:", retryData);

            // Construct options for the Razorpay payment modal
            // Razorpay options with handler for successful payment
            const options = {
                key: 'rzp_test_PzzQcMyTJaFFpy',
                amount: retryData.razorpayOrder.amount,
                currency: 'INR',
                name: 'Fly_kickz',
                description: 'Retry Payment',
                order_id: retryData.razorpayOrder.id,  // Ensure order_id is sent
                prefill: {
                    contact: '9000090000',
                    email: 'customer@example.com',
                    name: 'Customer Name',
                },
                theme: {
                    color: '#3399cc'
                },
                handler: async function (response) {
                    // Log Razorpay payment response
                    console.log('Razorpay payment response:', response);

                    // Now capture the payment response and retry data to send for verification
                    const payment = {
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_order_id: response.razorpay_order_id, // Capture the razorpay_order_id
                        razorpay_signature: response.razorpay_signature, // Capture the signature for verification
                    };

                    // Log the payment object before sending it to the backend
                    console.log('Payment object:', payment);
                    console.log('Retry data object:', retryData);

                    // Send to verify-retry-payment endpoint
                    verifyRetryPayment(payment, retryData);
                }
            };

            // Creating a new Razorpay payment instance
            const rzp = new Razorpay(options);
            rzp.open();

        } else {
            console.error("Failed to initiate retry payment");
        }
    } catch (error) {
        console.error('Error during retry payment:', error);
    }
}

// Function to verify retry payment
async function verifyRetryPayment(payment, retryData) {
    // Log the payment and retryData before sending the request
    console.log('Payment object:', payment);        // Log payment details
    console.log('Retry data object:', retryData);   // Log retry data details

    // Assuming order._id is available
    const payload = {
      payment: {
        razorpay_payment_id: payment.razorpay_payment_id, // Use payment object here
        razorpay_order_id: payment.razorpay_order_id,     // Use payment object here
        razorpay_signature: payment.razorpay_signature    // Use payment object here
      },
      order: {
        _id: '<%=order._id%>', // Send order._id
        success: true,
        razorpayOrder: retryData.razorpayOrder,  // Ensure you send the correct retryOrder data
        message: 'Retry payment order created successfully'
      }
    };

    console.log('Payload for verify-retry-payment:', payload);  // Log full payload

    const response = await fetch('/verify-retry-payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    });

    // Check the response status to debug the error
    if (response.ok) {
        console.log('Payment verification successful:', await response.json());
        Swal.fire({
            icon: 'success',
            title: 'Payment Successful',
            text: 'Your payment has been completed.',
            confirmButtonText: 'OK'
        }).then(() => {
            window.location.href = '/account';
        });
    } else {
        console.error('Payment verification failed:', await response.json());
        Swal.fire({
            icon: 'error',
            title: 'Payment Failed',
            text: 'Please try again.',
        });
    }
}

</script>


    <script>
      function cancelProduct(orderId, productId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "You won't be able to revert this!",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, cancel it!',
        cancelButtonText: 'No, keep it'
    }).then((result) => {
        if (result.isConfirmed) {
            // Send an AJAX request to cancel the product
            fetch('/cancel-product', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ orderId, productId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    Swal.fire(
                        'Cancelled!',
                        data.message,
                        'success'
                    );
                    // Optionally, refresh the page or update the product's status on the page
                    document.location.reload();
                } else {
                    Swal.fire(
                        'Error!',
                        'Unable to cancel the product',
                        'error'
                    );
                }
            })
            .catch(error => {
                Swal.fire(
                    'Error!',
                    'Something went wrong!',
                    'error'
                );
            });
        }
    });
}

    </script>
    <script>
        let currentOrderId, currentProductId;

        function openReturnModal(orderId, productId) {
            currentOrderId = orderId;
            currentProductId = productId;
            document.getElementById('returnModal').style.display = 'block';
        }

        function closeReturnModal() {
            document.getElementById('returnModal').style.display = 'none';
        }

        async function submitReturn() {
            const reason = document.getElementById('returnReason').value;

            if (!reason) {
                Swal.fire({
                    title: 'Error!',
                    text: 'Please provide a reason for the return',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
                return;
            }

            try {
                const response = await fetch('/return-product', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ orderId: currentOrderId, productId: currentProductId, reason })
                });

                const data = await response.json();

                if (response.ok) {
                    Swal.fire({
                        title: 'Success!',
                        text: data.message,
                        icon: 'success',
                        confirmButtonText: 'OK'
                    }).then(() => {
                        location.reload();
                    });
                } else {
                    Swal.fire({
                        title: 'Error!',
                        text: data.message,
                        icon: 'error',
                        confirmButtonText: 'OK'
                    });
                }
            } catch (error) {
                console.error('Error:', error);
                Swal.fire({
                    title: 'Error!',
                    text: 'Something went wrong!',
                    icon: 'error',
                    confirmButtonText: 'OK'
                });
            }
        }
    </script>

  </body>
</html>
