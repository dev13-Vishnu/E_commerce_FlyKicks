<!DOCTYPE HTML>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Evara Dashboard</title>
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:title" content="">
    <meta property="og:type" content="">
    <meta property="og:url" content="">
    <meta property="og:image" content="">
    <link rel="shortcut icon" type="image/x-icon" href="/admin/assets/imgs/theme/favicon.svg">
    <link href="/admin/assets/css/main.css" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        #cropModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        #cropModalContent {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 500px;
            max-height: 80%;
            overflow: auto;
            text-align: center;
        }

        #cropButton {
            margin-top: 10px;
        }

        #previewContainer {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        #previewContainer img {
            max-width: calc(50% - 10px);
            margin-bottom: 10px;
            height: auto;
        }
    </style>
</head>
<body>
    <div class="screen-overlay"></div>
    <%- include('./layouts/sidemenu.ejs') %>
    <main class="main-wrap">
        <%- include('./layouts/navbar.ejs') %>
        <section class="content-main">
            <div class="row">
                <div class="col-9">
                    <div class="content-header">
                        <h2 class="content-title">Add New Product</h2>
                        <% if (typeof Smessage != "undefined") { %>
                        <h4 class="text-success"><%= Smessage %></h4>
                        <% } %>
                    </div>
                </div>
                <% if (typeof message != "undefined") { %>
                <h4 class="text-danger"><%= message %></h4>
                <% } %>
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4>Basic</h4>
                        </div>
                        <div class="card-body">
                            <form method="post" action="/admin/addproduct" id="imageForm" enctype="multipart/form-data">
                                <div class="mb-4">
                                    <label for="product_name" class="form-label">Product title</label>
                                    <input type="text" name="product_name" placeholder="Type here" class="form-control" id="product_name">
                                </div>
                                <div class="mb-4">
                                    <label class="form-label">Full description</label>
                                    <textarea placeholder="Type here" name="description" class="form-control" rows="4"></textarea>
                                </div>
                                <div class="row">
                                    <div class="col-lg-4">
                                        <div class="mb-4">
                                            <label class="form-label">Regular price</label>
                                            <div class="row gx-2">
                                                <input placeholder="₹" type="text" class="form-control" name="product_Aprice" id="product_Aprice">
                                                <div class="text-danger" id="error_Paprice"></div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-lg-4">
                                        <div class="mb-4">
                                            <label class="form-label">Promotional price</label>
                                            <input placeholder="₹" type="text" class="form-control" name="product_Pprice" id="product_Pprice">
                                            <div id="error_Ppprice" class="text-danger"></div>
                                        </div>
                                    </div>
                                    <div class="col-sm-6 mb-3">
                                        <label class="form-label">Category</label>
                                        <select name="product_category" id="product_category" class="form-select">
                                            <% for (let i = 0; i < data.length; i++) { %>
                                            <% if (!data[i].delete) { %>
                                            <option value="<%= data[i]._id %>"><%= data[i].name %></option>
                                            <% } %>
                                            <% } %>
                                        </select>
                                    </div>
                                </div>
                                <div>
                                    <button class="btn btn-md rounded font-sm hover-up" type="submit">Upload</button>
                                </div>
                        </div>
                    </div>
                    
                    <div class="container">
                        <div id="previewContainer"></div>
                    </div>

                </div>
                
                
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4>Media</h4>
                        </div>
                        <div class="card-body">
                            <div class="mb-4">
                                <label for="images" class="form-label">Select Image</label>
                                <input type="file" class="form-control" id="images" name="images" accept="image/*" multiple required>
                                <div id="previewContainer"></div>
                            </div>
                        </div>
                    </div>
                    <div class="card mb-4">
                        <div class="card-header">
                            <h4>Stock</h4>
                        </div>
                        <div class="card-body">
                            <label for="7">7 Stock:</label>
                            <input type="number" class="form-control" id="7" name="stock[7]" min="0">
                            <br>
                            <label for="8">8 Stock:</label>
                            <input type="number" min="0" name="stock[8]" class="form-control" id="8">
                            <br>
                            <label for="9">9 Stock:</label>
                            <input type="number" min="0" name="stock[9]" class="form-control" id="9">
                            <br>
                            <label for="10">10 Stock:</label>
                            <input type="number" min="0" name="stock[10]" class="form-control" id="10">
                            <br>
                            <label for="11">11 Stock:</label>
                            <input type="number" min="0" name="stock[11]" class="form-control" id="11">
                            <br>
                            <label for="12">12 Stock:</label>
                            <input type="number" min="0" name="stock[12]" class="form-control" id="12">
                        </div>
                    </div>
                </div>
                </form>
            </div>
        </section>
        <div id="cropModal">
            <div id="cropModalContent">
                <img id="imageToCrop" src="" alt="Image to crop" style="max-width: 100%;">
                <button id="cropButton">Crop</button>
            </div>
        </div>
    </main>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
    <script>
        let cropper;
        let currentImageInput;

        $(document).on('change', 'input[type="file"]', function (e) {
            currentImageInput = this;
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    $('#imageToCrop').attr('src', event.target.result);
                    $('#cropModal').css('display', 'flex');
                    if (cropper) {
                        cropper.destroy();
                    }
                    cropper = new Cropper(document.getElementById('imageToCrop'), {
                        aspectRatio: 1,
                        viewMode: 1
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        $('#cropButton').on('click', function () {
            const canvas = cropper.getCroppedCanvas();
            canvas.toBlob(function (blob) {
                const url = URL.createObjectURL(blob);
                const img = document.createElement('img');
                img.src = url;
                $('#previewContainer').append(img);

                const croppedFile = new File([blob], currentImageInput.files[0].name, { type: 'image/jpeg', lastModified: Date.now() });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(croppedFile);
                currentImageInput.files = dataTransfer.files;

                $('#cropModal').css('display', 'none');
            }, 'image/jpeg');
        });

        $('#imageForm').on('submit', function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        $('input[type="file"]').each(function () {
            const files = $(this).prop('files');
            for (let i = 0; i < files.length; i++) {
                formData.append('images', files[i]);
            }
        });
        $.ajax({
            url: '/admin/addproduct',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                alert('Product added successfully');
            },
            error: function (err) {
                alert('Error adding product: ' + err.responseText);
            }
        });
    });

    </script>
</body>
</html>
